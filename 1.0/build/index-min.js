/*! temple - v1.0 - 2013-10-27 2:48:14 PM
* Copyright (c) 2013 tom; Licensed  */
KISSY.add("gallery/temple/1.0/rdparser",function(){function a(b){function c(a){this.text=a,this.lastPos=0,this.lineNo=this.colNo=1,this.track=function(a){a>=this.lastPos&&(this.lastPos++,"\n"===this.text[a]?(this.lineNo++,this.colNo=1):this.colNo++)}}function d(){var a=Array.prototype.slice.apply(arguments);return function(b){for(var c=0,d=b;c<a.length;c++){var e=a[c](d);if(e===d)return b;d=e}return d}}function e(){var a=Array.prototype.slice.apply(arguments);return function(b){for(var c=0;c<a.length;c++){var d=a[c](b);if(d!==b)return d}return b}}function f(a){return function(b){var c,d;for(c=b;(d=a(c))!==c;c=d);return c}}function g(a){return function(b){var c=a(b);return c!==b?c:{capture:b.capture,context:b.context,pos:b.pos}}}function h(a){return function(b){return b.pos>=b.context.text.length?b:a.test(b.context.text[b.pos])?(b.context.track(b.pos),{capture:b.capture,context:b.context,pos:b.pos+1}):b}}function i(a,b,c){return function(d){var e=a(d);if(e!==d){var f={prev:e.capture};if(f.name=b,"@"!==b[0]&&(f.value=d.context.text.substr(d.pos,e.pos-d.pos)),e.capture.next=f,e.capture=f,c){var g={prev:d.capture,next:d.capture.next};g.name=c,d.capture.next.prev=g,d.capture.next=g}}return e}}a.Context=c,this.parsingFunction=b(d,e,f,g,h,i),this.parse=function(a){var b={capture:{},context:new c(a),pos:0},d=this.parsingFunction(b),e=b.context;if(d.pos!=e.text.length){var f;f=e.lastPos>=e.text.length?"Unexpected end if input":"Unexpected token at ("+e.lineNo+":"+e.colNo+")";var g=new Error(f);throw g.$=d,g}return d.capture.next=null,[b.capture,d.capture]}}return a}),KISSY.add("gallery/temple/1.0/grammar",function(){var a=function(a){return function(a){return a(a)}(function(b){return a(function(){return b(b).apply(null,arguments)})})},b=Array.isArray?Array.isArray:function(a){return"[object Array]"===toString.call(a)},c=Array.forEach?Array.forEach:function(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c])},d=function(d,e,f,g,h,i){var j=function(a){var e;e=b(a)?a:a.split("");var f=[];return c(e,function(a){f.push(h(new RegExp(a)))}),d.apply(null,f)},k=e(d(h(/\\\\/),h(/'/)),h(/[^']/)),l=f(k),m=d(h(/'/),g(l),h(/'/)),n=e(d(h(/\\\\/),h(/'/)),h(/[^"]/)),o=f(n),p=d(h(/"/),g(o),h(/"/)),q=e(m,p),r=h(/\s/);g(r);var s=f(r),t=g(s),u=f(e(h(/[a-zA-Z_$]/))),v=g(f(e(h(/[a-zA-Z_$0-9]/)))),w=d(u,v),x=h(/0/),y=h(/\d/),z=h(/[123456789]/),A=a(function(a){return e(d(y,a),y)}),B=h(/[\+\-]/),C=h(/[eE]/),D=e(d(z,g(A)),x),E=d(C,g(B),D),F=d(D,d(h(/\./),g(A))),G=e(F,D),H=e(d(G,g(E)),F,D),I=d(g(B),t,H),J=e(j("true"),j("false")),K=h(/{/),L=h(/}/),M=w,N=j("#each"),O=j("as"),P=w,Q=w;P=i(P,"each-item"),M=i(M,"each-items"),Q=i(Q,"each-index");var R=d(K,N,t,M,t,O,t,P,t,Q,L);R=i(R,"@each-head-end","@each-head-start");var S=d(K,t,j("/each"),t,L),T=j("#if"),U=j("#elseif"),V=j("#else");e(q,w,I);var W=a(function(a){return e(d(w,h(/\./),a),w)}),X=e(I,W,q),Y=e(d(h(/=/),h(/=/)),d(h(/=/),h(/=/),h(/=/)),d(h(/>/),h(/=/)),d(h(/</),h(/=/)),d(h(/\+/),t,h(/=/)),d(h(/\-/),t,h(/=/)),d(h(/\|/),h(/\|/)),d(h(/&/),h(/&/)),h(/[\+\-\*\/%><\|\^]/)),Z=h(/[\+\-!]/),$=i(Y,"expatom"),_=i(Z,"expatom"),ab=i(X,"expatom"),bb=h(/,/),cb=i(bb,"expatom"),db=h(/\(/),eb=i(db,"expatom"),fb=h(/\)/),gb=i(fb,"expatom"),hb=h(/\./),ib=i(hb,"expatom"),jb=e(d(_,t,ab),d(_,t,eb,t,ab,t,gb),J,ab),kb=a(function(b){var c=a(function(a){return e(d(b,t,cb,t,a),b)}),f=d(g(_),t,i(W,"expatom"),t,eb,t,g(c),t,gb),h=e(f,jb),j=e(d(h,t,$,t,b),h),k=e(d(eb,t,j,t,gb),j),l=d(g(_),t,k),m=d(l,g(d(t,ib,t,W,g(d(eb,g(c),gb))))),n=a(function(a){return e(d(m,t,$,a),m)});return n}),lb=i(kb,"expression");lb=i(lb,"@ifexpend","@ifexpstart");var mb=d(K,t,U,t,lb,L),nb=d(K,t,V,t,L),ob=d(K,t,j("/if"),t,L),pb=d(K,t,i(kb,"expressionbody"),t,L);pb=i(pb,"@expressionend","@expressionstart");var qb=d(K,h(/#/),j("set"),t,i(W,"namespace"),t,h(/=/),t,i(kb,"expressionbody"),t,L);qb=i(qb,"@setend","@setstart");var rb=d(j("{#include"),t,i(w,"string"),t,h(/\}/));rb=i(rb,"@includeend","@includestart");var sb=j("{#block"),tb=j("{/block}"),ub=d(j("{#extend"),t,i(w,"string"),t,h(/\}/));ub=i(ub,"@extendend","@extendstart");var vb=e(j(["\\\\","\\}"]),h(/[^\}]/));vb=f(vb);var wb=d(j("{#!"),vb,h(/\}/)),xb=e(j(["\\\\","\\}"]),j(["\\\\","\\{"]),h(/[^\{\}]/));xb=f(xb),xb=i(xb,"string");var yb=a(function(a){a=f(a);var b=d(R,g(i(a,"@each-body-end","@each-body-start")),S);b=i(b,"@eachend","@eachstart");var c=d(mb,g(i(a,"@ifbodyend","@ifbodystart")));c=i(c,"@elseifend","@elseifstart");var h=g(f(c)),j=g(d(nb,t,g(a)));j=i(j,"@elseend","@elsestart");var k=d(K,T,t,lb,t,L,g(i(a,"@ifbodyend","@ifbodystart"))),l=d(i(k,"@elseifend","@elseifstart"),h,j,ob);l=i(l,"@ifend","@ifstart");var m=pb,n=qb,o=rb,p=d(sb,t,i(w,"string"),t,L,i(a,"@blockbodyend","@blockbodystart"),tb);p=i(p,"@blockend","@blockstart");var q=ub,r=wb,s=xb;return e(b,l,p,r,n,m,q,o,s)});return yb=f(yb)};return d}),KISSY.add("gallery/temple/1.0/toast",function(a,b,c){function d(a,b,c,e){var f=a.name;if("@ifend"==f||"@ifbodyend"==f||"@elseifend"==f||"@elseend"==f||"@setend"==f||"@includeend"==f||"@extendend"==f)c.length&&(b=c.pop());else if("@eachstart"==a.name){var g=["each"];b.push(g),c.push(b),b=g}else if("@eachend"==a.name)c.pop(),b=c.pop();else if("@each-head-start"==a.name){var h=[];b.push(h),c.push(b),b=h}else if("@each-body-start"==a.name){b=c.pop();var i=[];b.push(i),c.push(b),b=i}else if("each-items"==a.name)b.push(a.value);else if("each-item"==a.name)b.push(a.value);else if("each-index"==a.name)b.push(a.value);else if("@setstart"==a.name){var j=[],k=["set",j];c.push(b),b.push(k),b=j}else if("@blockstart"==a.name){var l=[],m=["block",l];b.push(m),c.push(b),c.push(m),b=l}else if("@blockend"==a.name)c.pop(),b=c.pop();else if("@ifstart"==a.name){var n=[],o=["if",n];b.push(o),c.push(b),c.push(o),b=n}else if("@ifbodystart"==a.name){var p=[];b.push(p),c.push(b),b=p}else if("@elseifstart"==a.name){var q=[];b.push(q),c.push(b),b=q}else if("@elsestart"==f){b=c.pop();var r=[];b.push(r),c.push(b),b=r}else if("@ifexpstart"==a.name){var s=[];b.push(s),c.push(b),b=s}else if("@ifexpend"==f)c.length&&(b=c.pop());else if("expatom"==a.name)b.push(a.value);else if("expressionbody"==a.name)b.push(a.value);else if("@expressionstart"==a.name){var t=[],u=["expression",t];c.push(b),b.push(u),b=t}else if("@expressionend"==a.name)b=c.pop();else if("namespace"==a.name)b.push(a.value);else if("expression"==a.name)b.push(a.value);else if("@includestart"==a.name){var v=["include"];b.push(v),c.push(b),b=v}else if("@extendstart"==a.name){var w=["extend"];e.extend++,e.context=w,b.push(w),c.push(b),b=w}else"number"==a.name?b.push(["number",a.value]):"string"==a.name&&b.push(["string",a.value.replace(/\n/gm,"\\n")]);a=a.next,a&&d(a,b,c,e)}var e=new b(c),f=function(a){var b=[],c=e.parse(a),f=c[0].next,g={extend:0};return f&&d(f,b,[],g),b.info=g,b};return f},{requires:["./rdparser","./grammar"]}),KISSY.add("gallery/temple/1.0/compile2js",function(S,toAST){function gensymbol(a){a||(a={});var b;return b=a.pre?String(a.pre)+unique++:default_var_name_pre+unique++}function filterAST(a){function b(a){for(var d=0,e=a.length;e>d;d++){var f=a[d],g=a[0],h=a[1];"block"===g?c[h[0][1]]=h:isarray(f)&&b(f)}}var c={};return b(a),c}function extendListWithBlocks(a,b){function c(a){for(var d=0,e=a.length;e>d;d++){var f=a[d],g=f[0],h=f[1];"block"===g&&isarray(f)?b[h[0][1]]&&(f[1]=b[h[0][1]]):isarray(h)&&c(h)}}return c(a),a}function isLocalFn(a){return!!localfns[a]}function isGlobalFn(a){return!!this[a]}function isExpAtom(a){return indexOf(expatom,a)>-1}function _compile(a,b,c){var d="";if("if"===a[0]){for(var e,f=a[1],g=0,h=f.length;h>g;g++){e=f[g],g?d+="else if(":d=d+b+"if(";for(var i=e[0],j=i.length,k=i.slice(0,j-1),l="",m=0,n=k.length;n>m;m++)l+=isExpAtom(k[m])?k[m]:nshandle(k[m],c);d+=l,d+=")",d+="{\n";var o=e[1];if(o)for(var p=0,q=o.length;q>p;p++)d=d+_compile(o[p],b+INDENT,c)+"\n";d=d+b+"}"}if(a[2]&&a[2].length){d+="else",d+="{\n";for(var r=a[2],s=0;s<r.length;s++)d=d+_compile(r[s],b+INDENT,c)+"\n";d=d+b+"}",d=d}d=d}else if("each"===a[0]){var t=a[1],u=a[2];if(u){var v=gensymbol({pre:"i_"}),w=gensymbol({pre:"item_"}),x=gensymbol({pre:"len_"}),y=t[0];y=c[y]?c[y]:ENV+"."+y,d=d+b+"for(var "+v+" = 0 , "+x+" = "+y+".length ; "+v+" < "+x+"; "+v+"++){\n";var z=t[2],A=t[1],B=derive(c);d=d+INDENT+b+"var "+w+" = "+y+"["+v+"];\n",B[z]=v,B[A]=w;for(var C=0,D=u.length;D>C;C++)d=d+_compile(u[C],b+INDENT,B)+"\n";d=d+b+"}"}d=d}else if("set"===a[0]){for(var E=a[1],F=E[0],G=E.slice(1,E.length-1),l="",C=0,D=G.length;D>C;C++)l+=isExpAtom(G[C])?G[C]:nshandle(G[C],c);d=F.indexOf(".")>-1?d+b+F+" = "+l+";":d+b+"var "+F+" = "+l+";"}else if("block"===a[0])for(var H=a[1].slice(1),C=0,D=H.length;D>C;C++){var I=_compile(H[C],b,{})+"\n";d+=d+I}else if("include"===a[0]){var J=a[1][1],K="";if(subs[J])for(var L=toAST(subs[J]),C=0,D=L.length;D>C;C++)K+=_compile(L[C],b,{})+"\n";d+=d+K}else if("expression"===a[0]){for(var M=a[1],G=M.slice(0,M.length-1),l="",C=0,D=G.length;D>C;C++){var N=G[C];l+=isExpAtom(N)?N:nshandle(N,c)}d=b+stringname+" += "+l}else if("string"===a[0]){var l;a[1]&&(d=isstrnum(a[1])?b+stringname+" += "+a[1]:b+stringname+' += "'+a[1]+'"')}else this.console&&console.log("no case",a),d="";return d}function compile(s){var js=to_js(s),ret=eval("("+js+")");return ret}function getast(a){var b=toAST(a),c=b.info;if(c.extend>0){var d=c.context[1][1];if(!subs[d])throw Error('extend "'+d+'", but can not find it');var e=filterAST(b);b=getast(subs[d]),b=extendListWithBlocks(b,e)}return b}function to_js(a){var b=getast(a);return _to_js(b)}function _to_js(a){for(var b=INDENT+INDENT,c="",d=0,e=a.length;e>d;d++)c=c+_compile(a[d],b,{})+"\n";return c="{\n  render:function("+ENV+"){\n"+"    var "+stringname+' = "";\n'+c+"    return "+stringname+";\n"+"  }\n"+"}\n"}var INDENT="  ",ENV,Temple;window.Temple||(Temple=window.Temple={});var unique=0,default_var_name_pre="variable_",stringname=gensymbol({pre:"string_"});ENV=gensymbol({pre:"env_"});var derive=function(a){var b=function(){};return b.prototype=a,new b},indexOf=Array.indexOf?Array.indexOf:function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},isarray=Array.isArray?Array.isArray:function(a){return"[object Array]"===toString.call(a)},isstr=function(a){return'"'==a[0]||"'"==a[0]},isnum=function(a){return/\d/.test(a[0])},isstrnum=function(a){var b=isnum(a),c=isstr(a);return b||c},nshandle=function(a,b){var c=a.split("."),d=c[0];return"this"==d?a:isstrnum(a)?a:c.length>1?b[d]?b[d]+"."+c.slice(1):this[d]||isLocalFn(d)?a:ENV+"."+a:b[d]?b[d]:isLocalFn(d)?"Temple.__fns."+[d]:isGlobalFn(d)?a:ENV+"."+a},subs={};Temple.add=function(a,b){subs[a]=b},Temple.remove=function(a){subs[a]&&delete subs[a]};var regvar=/[a-zA-Z_$][a-zA-Z_$0-9]*/g,localfns=Temple.__fns={};Temple.reg=function(a,b){localfns[a]=b};var expatom=["=","==","===",">=","<=","+=","-=","&&","||","+","-","*","/","%","|",">","<","^",",",".","(",")"];return Temple.to_js=to_js,Temple.compile=compile,Temple},{requires:["./toast"]}),KISSY.add("gallery/temple/1.0/index",function(a,b){return b},{requires:["./compile2js"]});